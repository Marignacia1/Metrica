{% extends "layout.html" %}

{% block title %}Dashboard General{% endblock %}
{% block page_title %}Dashboard General{% endblock %}

{% if session.usuario.permisos.cargar_archivos %}
    <div class="d-none">
         <form method="POST" enctype="multipart/form-data"></form>
    </div>
{% endif %}

{% block content %}
<style>
  /* =========================================
     1. ESTILOS GENERALES Y ANIMACIONES
     ========================================= */
  .hover-scale {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }
  .hover-scale:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
    z-index: 10;
  }
  
  /* Animaci√≥n Fade In Up */
  .fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translate3d(0, 20px, 0); }
    to { opacity: 1; transform: translate3d(0, 0, 0); }
  }

  /* =========================================
     2. TARJETAS KPI (DISE√ëO CLEAN)
     ========================================= */
  .card-clean {
    border: 1px solid rgba(0,0,0,0.05);
    border-top-width: 4px !important;
    background: #fff;
    border-radius: 8px;
  }
  .card-clean .icon-shape {
    width: 48px; height: 48px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;
  }
  
  /* Colores de Borde Superior */
  .border-top-primary { border-top-color: #3b82f6 !important; }
  .border-top-danger  { border-top-color: #ef4444 !important; }
  .border-top-info    { border-top-color: #06b6d4 !important; }
  .border-top-success { border-top-color: #10b981 !important; }
  .border-top-warning { border-top-color: #f59e0b !important; }
  .border-top-dark    { border-top-color: #1f2937 !important; }
  
  /* Fondos suaves para iconos */
  .bg-light-primary { background-color: #eff6ff; color: #3b82f6; }
  .bg-light-danger  { background-color: #fef2f2; color: #ef4444; }
  .bg-light-info    { background-color: #ecfeff; color: #06b6d4; }
  .bg-light-success { background-color: #ecfdf5; color: #10b981; }
  .bg-light-warning { background-color: #fffbeb; color: #f59e0b; }
  .bg-light-dark    { background-color: #f3f4f6; color: #1f2937; }

  /* =========================================
     3. TABLAS DE DATOS (Acordeones Y Resultados Filtro)
     ========================================= */
  .accordion-body .table,
  #resultados-filtro .table {
      table-layout: fixed !important;
      width: 100%;
      border-collapse: collapse;
  }

  .accordion-body .table thead th,
  #resultados-filtro .table thead th {
      background-color: #f8f9fa;
      color: #495057;
      font-size: 0.7rem;
      text-transform: uppercase;
      font-weight: 700;
      padding: 12px 8px;
      border-bottom: 2px solid #dee2e6;
      vertical-align: middle;
      text-align: left !important;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
  }
  
  .accordion-body .table thead th:first-child,
  #resultados-filtro .table thead th:first-child { text-align: center !important; }

  .accordion-body .table tbody td,
  #resultados-filtro .table tbody td {
      padding: 8px 8px;
      vertical-align: top;
      font-size: 0.8rem;
      color: #344767;
      border-bottom: 1px solid #e9ecef;
      white-space: normal !important; 
      word-wrap: break-word;
      overflow-wrap: anywhere;
  }

  /* ANCHOS DE COLUMNA */
  .accordion-body .table tr > *:nth-child(1),
  #resultados-filtro .table tr > *:nth-child(1) {
      width: 8%; min-width: 60px; font-weight: bold; color: #3b82f6; text-align: center !important;
  }
  .accordion-body .table tr > *:nth-child(2),
  #resultados-filtro .table tr > *:nth-child(2) { width: 30%; text-align: left; font-weight: 500; line-height: 1.3; }
  .accordion-body .table tr > *:nth-child(3),
  #resultados-filtro .table tr > *:nth-child(3) { width: 18%; text-align: left; }
  .accordion-body .table tr > *:nth-child(4),
  #resultados-filtro .table tr > *:nth-child(4) { width: 18%; text-align: left; }
  .accordion-body .table tr > *:nth-child(n+5),
  #resultados-filtro .table tr > *:nth-child(n+5) { width: auto; color: #6c757d; }
  
  .accordion-body .table tbody tr:hover,
  #resultados-filtro .table tbody tr:hover { background-color: #fafbfc; }

  /* =========================================
     4. TABLAS DE RESUMEN (Inferiores)
     ========================================= */
  #tabla-resumen-unidades, #tabla-resumen-estados, #tabla-distribucion-tipo {
      width: 100%; table-layout: fixed !important; border-collapse: collapse;
  }
  #tabla-resumen-unidades th, #tabla-resumen-unidades td,
  #tabla-resumen-estados th, #tabla-resumen-estados td,
  #tabla-distribucion-tipo th, #tabla-distribucion-tipo td {
      padding: 10px 12px; vertical-align: middle; font-size: 0.85rem; border-bottom: 1px solid #f0f2f5;
  }
  
  /* A. Por Unidad */
  #tabla-resumen-unidades th:nth-child(1), #tabla-resumen-unidades td:nth-child(1) { width: 50%; text-align: left !important; }
  #tabla-resumen-unidades th:nth-child(2), #tabla-resumen-unidades td:nth-child(2) { width: 30%; text-align: right !important; font-family: monospace; font-weight: bold; }
  #tabla-resumen-unidades th:nth-child(3), #tabla-resumen-unidades td:nth-child(3) { width: 20%; text-align: center !important; }

  /* B. Por Estado */
  #tabla-resumen-estados th:nth-child(1), #tabla-resumen-estados td:nth-child(1) { 
      width: 50%; 
      text-align: left !important; 
      padding-left: 15px; 
  }
  #tabla-resumen-estados th:nth-child(2), #tabla-resumen-estados td:nth-child(2) { 
      width: 15%; 
      text-align: center !important; 
  }
  #tabla-resumen-estados th:nth-child(3), #tabla-resumen-estados td:nth-child(3) { 
      width: 35%; 
      text-align: right !important; 
      font-family: 'Consolas', 'Monaco', monospace; 
      font-weight: 600;
      color: #344767;
  }
</style>
 
{% if kpis %}
<div class="row">
    <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
        <div class="card card-clean border-top-primary shadow-sm hover-scale h-100">
            <div class="card-body p-3 text-center">
                <div class="icon-shape bg-light-primary mx-auto"><i class="ri-inbox-line text-lg"></i></div>
                <h3 class="mb-0 font-weight-bold">{{ kpis.get('total_brutos', 0) }}</h3>
                <p class="text-xs text-uppercase text-muted font-weight-bold mb-0 mt-2">Ingresados</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
        <div class="card card-clean border-top-danger shadow-sm hover-scale h-100">
            <div class="card-body p-3 text-center">
                <div class="icon-shape bg-light-danger mx-auto"><i class="ri-close-circle-line text-lg"></i></div>
                <h3 class="mb-0 font-weight-bold">{{ kpis.get('req_cancelados', 0) }}</h3>
                <p class="text-xs text-uppercase text-muted font-weight-bold mb-0 mt-2">Cancelados</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
        <div class="card card-clean border-top-dark shadow-sm hover-scale h-100">
            <div class="card-body p-3 text-center">
                <div class="icon-shape bg-light-dark mx-auto"><i class="ri-magic-line text-lg"></i></div>
                <h3 class="mb-0 font-weight-bold">{{ kpis.get('total_neto', 0) }}</h3>
                <p class="text-xs text-uppercase text-muted font-weight-bold mb-0 mt-2">Req Limpios</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
        <div class="card card-clean border-top-success shadow-sm hover-scale h-100">
            <div class="card-body p-3 text-center">
                <div class="icon-shape bg-light-success mx-auto"><i class="ri-checkbox-circle-line text-lg"></i></div>
                <h3 class="mb-0 font-weight-bold">{{ kpis.get('req_procesados', 0) }}</h3>
                <p class="text-xs text-uppercase text-muted font-weight-bold mb-0 mt-2">Procesados</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
        <div class="card card-clean border-top-info shadow-sm hover-scale h-100">
            <div class="card-body p-3 text-center">
                <div class="icon-shape bg-light-info mx-auto"><i class="ri-speed-line text-lg"></i></div>
                <h3 class="mb-0 font-weight-bold">{{ kpis.get('eficiencia_operacional', 0) }}%</h3>
                <p class="text-xs text-uppercase text-muted font-weight-bold mb-0 mt-2">Efic. Admisi√≥n</p>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-4">
        <div class="card card-clean border-top-warning shadow-sm hover-scale h-100">
            <div class="card-body p-3 text-center">
                <div class="icon-shape bg-light-warning mx-auto"><i class="ri-percent-line text-lg"></i></div>
                <h3 class="mb-0 font-weight-bold">{{ kpis.get('eficiencia', 0) }}%</h3>
                <p class="text-xs text-uppercase text-muted font-weight-bold mb-0 mt-2">Efic. Proceso</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
  <div class="col-12">
    <div class="accordion" id="accordionDetallesReq">
      
      <div class="accordion-item shadow-xs mb-3">
        <h2 class="accordion-header d-flex align-items-center justify-content-between pe-3" id="headingProcesados">
          <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProcesados">
            ‚úÖ Requerimientos Procesados
            {% if kpis.get('req_procesados', 0) > 0 %}
              <span class="badge bg-success ms-3">{{ kpis.get('req_procesados', 0) }}</span>
            {% endif %}
          </button>
          {% if df_procesados_html %}
          <a href="{{ url_for('descargar_excel', tipo_reporte='procesados') }}" class="btn btn-sm bg-gradient-success mb-0 ms-2">
              <i class="fas fa-file-excel me-1"></i> Excel
          </a>
          {% endif %}
        </h2>
        <div id="collapseProcesados" class="accordion-collapse collapse" data-bs-parent="#accordionDetallesReq">
          <div class="accordion-body">
            {% if df_procesados_html %}
              {{ df_procesados_html | safe }}
            {% else %}
              <p class="text-muted text-center">No hay requerimientos procesados en esta sesi√≥n.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="accordion-item shadow-xs mb-3">
        <h2 class="accordion-header d-flex align-items-center justify-content-between pe-3" id="headingEnProceso">
          <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEnProceso">
            ‚è≥ Requerimientos en Proceso
            {% if kpis.get('req_en_proceso', 0) > 0 %}
              <span class="badge bg-warning ms-3">{{ kpis.get('req_en_proceso', 0) }}</span>
            {% endif %}
          </button>
          {% if df_en_proceso_html %}
          <a href="{{ url_for('descargar_excel', tipo_reporte='en_proceso') }}" class="btn btn-sm bg-gradient-success mb-0 ms-2">
              <i class="fas fa-file-excel me-1"></i> Excel
          </a>
          {% endif %}
        </h2>
        <div id="collapseEnProceso" class="accordion-collapse collapse" data-bs-parent="#accordionDetallesReq">
          <div class="accordion-body">
            {% if df_en_proceso_html %}
              {{ df_en_proceso_html | safe }}
            {% else %}
              <p class="text-muted text-center">¬°Excelente! No hay requerimientos en proceso.</p>
            {% endif %}
          </div>
        </div>
      </div>
      
      {% if analisis_financiero and analisis_financiero.unmatched_ocs %}
      <div class="accordion-item shadow-xs mb-3">
        <h2 class="accordion-header" id="headingUnmatched">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUnmatched">
            üîç OCs sin Match en Experto Hist√≥rico
            <span class="badge bg-danger ms-3">{{ analisis_financiero.unmatched_ocs|length }}</span>
          </button>
        </h2>
        <div id="collapseUnmatched" class="accordion-collapse collapse" data-bs-parent="#accordionDetallesReq">
          <div class="accordion-body">
            <p>Las siguientes √≥rdenes de compra no encontraron correspondencia:</p>
            <ul class="list-group">
              {% for oc in analisis_financiero.unmatched_ocs %}
              <li class="list-group-item">{{ oc }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-lg-6 mb-4">
    <div class="card border shadow-xs h-100">
      <div class="card-header border-bottom pb-0">
        <h6 class="mb-0">üìã Distribuci√≥n por Tipo de Compra</h6>
        <p class="text-sm mb-2">An√°lisis detallado de los datos procesados</p>
      </div>
      <div class="card-body px-0 py-0">
        <div class="table-responsive p-0">
          <table class="table align-items-center mb-0 table-compact" id="tabla-distribucion-tipo">
            <thead>
              <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tipo de Compra</th>
                <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Cantidad</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Detalle</th>
              </tr>
            </thead>
            <tbody>
              {% for item in tabla_distribucion %}
              <tr>
                <td><div class="d-flex px-2"><h6 class="mb-0">{{ item.tipo_compra }}</h6></div></td>
                <td class="align-middle text-center"><span class="text-secondary font-weight-bold">{{ item.cantidad }}</span></td>
                <td class="align-middle"><span class="text-secondary text-xs font-weight-bold">{{ item.subtipo }}</span></td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="text-center text-muted py-4">No hay datos.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  {% if graficos.get('distribucion_tipos') %}
  <div class="col-lg-6 mb-4">
    <div class="card border shadow-xs h-100">
      <div class="card-header border-bottom pb-0">
        <h6 class="mb-0">Distribuci√≥n de Procesados</h6>
        <p class="text-sm mb-0">Requerimientos que finalizaron con una OC</p>
      </div>
      <div class="card-body p-3 d-flex align-items-center">
        {{ graficos.distribucion_tipos | safe }}
      </div>
    </div>
  </div>
  {% endif %}
</div>

{% if graficos.get('top_unidades') %}
<div class="row mt-2">
  <div class="col-12 mb-4">
    <div class="card border shadow-xs h-100">
      <div class="card-header border-bottom pb-0">
        <h6 class="mb-0">Top 10 Unidades Solicitantes</h6>
        <p class="text-sm mb-0">Unidades con m√°s requerimientos procesados</p>
      </div>
      <div class="card-body p-3">
        {{ graficos.top_unidades | safe }}
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if session.usuario.permisos.cargar_archivos %}
<div class="row mt-4">
  <div class="col-12">
    <div class="card border shadow-xs">
      <div class="card-header border-bottom pb-0 d-flex justify-content-between align-items-center">
        <div>
          <h6 class="font-weight-semibold text-lg mb-0">üí∞ An√°lisis Financiero de √ìrdenes de Compra</h6>
          <p class="text-sm mb-0">Carga los archivos para an√°lisis monetario</p>
        </div>
        {% if analisis_financiero %}
        <a href="{{ url_for('descargar_excel', tipo_reporte='financiero') }}" class="btn btn-sm bg-gradient-success mb-0">
            <i class="fas fa-file-excel me-1"></i> Excel Financiero
        </a>
        {% endif %}
      </div>
      <div class="card-body px-0 py-0">
        <div class="p-4">
          <form method="POST" enctype="multipart/form-data">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="resultado_oc" class="form-label">üìä ListadoResultadoOC (Obligatorio)</label>
                <input type="file" class="form-control" name="resultado_oc" accept=".xlsx,.xls,.csv" required>
                <small class="text-muted">Archivo con todas las √≥rdenes de compra emitidas</small>
              </div>
              <div class="col-md-6 mb-3">
                <label for="experto_historico" class="form-label">üìÅ Experto Hist√≥rico (Obligatorio)</label>
                <input type="file" class="form-control" name="experto_historico" accept=".xlsx,.xls,.csv" required>
                <small class="text-muted">Solicitud en Bruto con todos los requerimientos</small>
              </div>
            </div>
            <div class="text-end">
              <button type="submit" class="btn btn-primary btn-sm mb-0">
                <i class="fas fa-chart-line me-2"></i>Analizar Archivos
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if analisis_financiero %}
<div class="row mt-4">
  <div class="col-12 mb-4">
    <div class="card border shadow-xs">
      <div class="card-header border-bottom pb-0">
        <h6 class="font-weight-semibold text-lg mb-2">üíµ Indicadores Financieros</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 text-center mb-3">
            <div class="p-4 border-radius-lg" style="background: linear-gradient(135deg, #4b5563 0%, #1f2937 100%);">
              <h6 class="text-white text-sm mb-1">Monto Total Transado</h6>
              <h3 class="text-white font-weight-bold mb-0">{{ analisis_financiero.kpis_financieros.monto_total_bruto }}</h3>
            </div>
          </div>
          <div class="col-md-3 text-center mb-3">
            <div class="p-4 border-radius-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <h6 class="text-white text-sm mb-1">Monto Total V√°lido</h6>
              <h3 class="text-white font-weight-bold mb-0">{{ analisis_financiero.kpis_financieros.monto_total_valido }}</h3>
            </div>
          </div>
          <div class="col-md-3 text-center mb-3">
            <div class="p-4 border-radius-lg" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
              <h6 class="text-white text-sm mb-1">Recepci√≥n Conforme</h6>
              <h3 class="text-white font-weight-bold mb-0">{{ analisis_financiero.kpis_financieros.monto_conforme }}</h3>
            </div>
          </div>
          <div class="col-md-3 text-center mb-3">
            <div class="p-4 border-radius-lg" style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);">
              <h6 class="text-white text-sm mb-1">Efectividad $</h6>
              <h3 class="text-white font-weight-bold mb-0">{{ analisis_financiero.kpis_financieros.efectividad }}</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if analisis_financiero.graficos %}
  <div class="col-12 mb-4">
    <div class="card border shadow-xs">
      <div class="card-header border-bottom pb-0">
        <h6 class="font-weight-semibold text-lg mb-2">üìä An√°lisis de Compras por Unidad y Tipo</h6>
      </div>
      <div class="card-body">
        {% if analisis_financiero.graficos.get('top_unidades_monto') %}
        <div class="row">
          <div class="col-12 mb-4 border-bottom pb-4">
            <h6 class="text-sm font-weight-bold mb-3">üí∞ Top 5 Unidades por Monto Total</h6>
            {{ analisis_financiero.graficos.top_unidades_monto | safe }}
          </div>
        </div>
        {% endif %}

        <div class="row mt-3">
          {% if analisis_financiero.graficos.get('top_unidades_cantidad') %}
          <div class="col-lg-6 mb-4">
            <h6 class="text-sm font-weight-bold mb-3">üìä Top 5 Unidades por Cantidad</h6>
            {{ analisis_financiero.graficos.top_unidades_cantidad | safe }}
          </div>
          {% endif %}
          
          {% if analisis_financiero.graficos.get('distribucion_monto_tipo') %}
          <div class="col-lg-6 mb-4">
            <h6 class="text-sm font-weight-bold mb-3">üìà Distribuci√≥n del Monto por Tipo</h6>
            {{ analisis_financiero.graficos.distribucion_monto_tipo | safe }}
          </div>
          {% endif %}
        </div>

        {% if analisis_financiero.tabla_resumen_unidades %}
        <div class="row mt-4 pt-4 border-top">
          <div class="col-lg-6 mb-4">
            <div class="card border shadow-xs h-100">
                <div class="card-header border-bottom pb-0">
                    <h6 class="font-weight-semibold text-lg mb-0">üìã Resumen Detallado por Unidad</h6>
                    <p class="text-sm text-secondary mb-2">Desglose de montos y cantidades</p>
                </div>
                <div class="card-body px-0 py-0">
                    <div class="table-responsive p-0" style="max-height: 500px; overflow-y: auto;">
                        {{ analisis_financiero.tabla_resumen_unidades | safe }}
                    </div>
                </div>
            </div>
          </div>

          <div class="col-lg-6 mb-4">
            <div class="card border shadow-xs h-100">
                <div class="card-header border-bottom pb-0">
                    <h6 class="font-weight-semibold text-lg mb-0">üç© Distribuci√≥n por Financiamiento</h6>
                    <p class="text-sm text-secondary mb-2">Toca una secci√≥n para ver el detalle</p>
                </div>
                <div class="card-body p-3">
                    <div class="chart-container" style="position: relative; height:350px; width:100%">
                        <canvas id="chartFinanciamiento"></canvas>
                    </div>
                    <div class="mt-4 text-center text-xs text-muted">
                        <i class="ri-cursor-line me-1"></i> Haz clic en el gr√°fico para abrir el reporte
                    </div>
                </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  {% if analisis_financiero.tabla_estados %}
  <div class="col-12 mb-4">
    <div class="card border shadow-xs">
      <div class="card-header border-bottom pb-0">
        <h6 class="font-weight-semibold text-lg mb-2">üìä Distribuci√≥n de OCs por Estado</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-lg-5 mb-4">
            <h6 class="text-sm font-weight-bold mb-3">Resumen por Estado</h6>
            <div class="table-responsive">{{ analisis_financiero.tabla_estados | safe }}</div>
          </div>
          {% if analisis_financiero.grafico_estados %}
          <div class="col-lg-7 mb-4">
            <h6 class="text-sm font-weight-bold mb-3">Visualizaci√≥n de Estados</h6>
            {{ analisis_financiero.grafico_estados | safe }}
          </div>
          {% endif %}
        </div>

        {% if analisis_financiero.estados_disponibles %}
        <div class="row mt-4 pt-4 border-top">
          <div class="col-12">
            <h6 class="text-sm font-weight-bold mb-3">üîç Filtrar por Estado de OC</h6>
            <form id="form-filtro-estado">
              <div class="row align-items-end">
                <div class="col-md-8">
                  <select class="form-select" name="estado_filtro" id="estado_filtro">
                    <option value="">-</option>
                    {% for estado in analisis_financiero.estados_disponibles %}
                    <option value="{{ estado }}">{{ estado }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <button type="button" onclick="filtrarAhora()" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-filter me-2"></i>Filtrar
                  </button>
                </div>
              </div>
            </form>
            <div id="resultados-filtro" class="mt-4"></div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endif %}

{% else %}
<div class="row mt-4">
  <div class="col-12">
    <div class="card border shadow-xs text-center p-5">
        <i class="fas fa-chart-line fa-3x text-secondary mb-3"></i>
        <h5 class="text-secondary">No hay datos disponibles</h5>
        <p class="text-sm text-secondary mb-0">Carga archivos para ver los KPIs y an√°lisis</p>
    </div>
  </div>
</div>
{% endif %}

<div class="modal fade" id="modalDetalleFinanciamiento" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header border-bottom">
        <h5 class="modal-title font-weight-bold" id="modalTitle">Detalle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
          <table class="table align-items-center mb-0 table-hover">
            <thead class="bg-light sticky-top" style="z-index: 1;">
              <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-3">ID OC / Req</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Descripci√≥n</th>
                <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Estado</th>
                <th class="text-end text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 pe-3">Monto</th>
              </tr>
            </thead>
            <tbody id="cuerpoTablaModal"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer border-top-0 py-2">
        <button type="button" class="btn btn-light btn-sm mb-0" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    const bluePalette = ['#0D47A1', '#1565C0', '#1976D2', '#1E88E5', '#42A5F5', '#64B5F6', '#90CAF9', '#BBDEFB', '#E3F2FD'];
    Chart.register(ChartDataLabels);

    {% if analisis_financiero and analisis_financiero.datos_json_financiamiento %}
    document.addEventListener("DOMContentLoaded", function() {
        const datosRaw = {{ analisis_financiero.datos_json_financiamiento | tojson | safe }};
        if (!datosRaw || datosRaw.length === 0) return;

        const agrupados = {};
        datosRaw.forEach(item => {
            let key = item.financiamiento || 'Sin Asignar';
            if (!agrupados[key]) agrupados[key] = { monto: 0, cantidad: 0, items: [] };
            agrupados[key].monto += item.monto;
            agrupados[key].cantidad += 1;
            agrupados[key].items.push(item);
        });

        const sortedKeys = Object.keys(agrupados).sort((a, b) => agrupados[b].monto - agrupados[a].monto);
        const labels = sortedKeys;
        const dataMontos = sortedKeys.map(k => agrupados[k].monto);
        
        const ctxElement = document.getElementById('chartFinanciamiento');
        if (ctxElement) {
            new Chart(ctxElement.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataMontos,
                        backgroundColor: bluePalette,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '30%', 
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => ` ${context.label}: ${new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(context.raw)}`
                            }
                        },
                        datalabels: {
                            color: '#ffffff',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value, context) => {
                                let sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum);
                                return percentage > 3 ? [context.chart.data.labels[context.dataIndex], percentage.toFixed(1) + "%"] : null;
                            },
                            textAlign: 'center'
                        }
                    },
                    onClick: (e, activeElements) => {
                        if (activeElements.length > 0) abrirModalDetalle(labels[activeElements[0].index], agrupados);
                    }
                }
            });
        }
    });

    function abrirModalDetalle(nombreGrupo, dataAgrupada) {
        const grupo = dataAgrupada[nombreGrupo];
        document.getElementById('modalTitle').innerHTML = `Financiamiento: <span class="text-primary">${nombreGrupo}</span>`;
        const tbody = document.getElementById('cuerpoTablaModal');
        tbody.innerHTML = '';
        grupo.items.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td class="ps-3 py-3">
                        <span class="font-monospace font-weight-bold text-primary text-xs">${item.orden}</span>
                        ${item.req ? `<div class="text-xs text-muted mt-1">Req: ${item.req}</div>` : ''}
                    </td>
                    <td class="py-3"><p class="text-xs mb-0" style="white-space:normal;">${item.descripcion}</p></td>
                    <td class="text-center"><span class="badge bg-light text-dark border text-xxs">${item.estado}</span></td>
                    <td class="text-end pe-3"><strong>${item.monto_fmt}</strong></td>
                </tr>`;
        });
        new bootstrap.Modal(document.getElementById('modalDetalleFinanciamiento')).show();
    }
    {% endif %}

    function filtrarAhora() {
        const resultadosDiv = document.getElementById('resultados-filtro');
        resultadosDiv.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
        fetch('{{ url_for("filtrar_por_estado") }}', { 
            method: 'POST', 
            body: new FormData(document.getElementById('form-filtro-estado'))
        })
        .then(r => r.text())
        .then(html => {
            resultadosDiv.innerHTML = `<div class="card border shadow-xs mt-4 fade-in-up"><div class="card-body px-0 py-0">${html}</div></div>`;
        });
    }
</script>
{% endblock %}