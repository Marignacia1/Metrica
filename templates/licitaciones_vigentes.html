{% extends "layout.html" %}

{% block title %}Gesti贸n de Licitaciones Vigentes{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1> Gesti贸n de Licitaciones Vigentes</h1>
    <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#modalAddLicitacion">
        <i class="fas fa-plus-circle me-1"></i> Agregar Licitaci贸n
    </button>
</div>

<div id="alert-container"></div>

<div class="accordion shadow-sm" id="accordionLicitaciones">
    {% for licitacion in licitaciones %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ licitacion.id }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ licitacion.id }}">
                <span class="badge bg-primary me-2">{{ licitacion.id_licitacion }}</span> 
                <strong>{{ licitacion.nombre_licitacion }}</strong> 
                <span class="ms-2 text-muted small">| Resp: {{ licitacion.requirente }}</span>
            </button>
        </h2>
        <div id="collapse-{{ licitacion.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionLicitaciones">
            <div class="accordion-body bg-light">
                <div class="mb-3 d-flex gap-2 flex-wrap">
                    <button class="btn btn-success btn-sm" onclick="showAddConvenioModal({{ licitacion.id }})">
                        <i class="fas fa-user-plus"></i> Agregar Proveedor
                    </button>
                    
                    <button class="btn btn-secondary btn-sm" onclick="showEditLicitacionModal(this)" data-json='{{ licitacion|tojson|forceescape }}'>
                        <i class="fas fa-edit"></i> Modificar Licitaci贸n
                    </button>

                    <a href="{{ url_for('generar_pdf_licitacion_ruta', licitacion_id=licitacion.id) }}" class="btn btn-danger btn-sm">
                        <i class="fas fa-file-pdf"></i> Generar PDF
                    </a>
                    
                    <form id="form-del-lic-{{ licitacion.id }}" action="{{ url_for('api_delete_licitacion', licitacion_id=licitacion.id) }}" method="POST" class="d-inline" onsubmit="return confirm('驴Eliminar licitaci贸n y todos sus datos?');">
                        <button type="submit" class="btn btn-outline-danger btn-sm"><i class="fas fa-trash"></i> Eliminar</button>
                    </form>
                </div>

                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body row">
                        <div class="col-md-4"><p class="mb-1"><strong>Estado:</strong> <span class="badge bg-success">VIGENTE</span></p></div>
                        <div class="col-md-4"><p class="mb-1"><strong>Decreto Adjudicaci贸n:</strong> {{ licitacion.decreto_adjudicacion or 'N/A' }}</p></div>
                        <div class="col-md-4"><p class="mb-1"><strong>Inspector T茅cnico:</strong> {{ licitacion.inspector_tecnico or 'N/A' }}</p></div>
                    </div>
                </div>

                <h5 class="mb-3"><i class="fas fa-truck me-2"></i>Proveedores Adjudicados</h5>
                
                {% for convenio in licitacion.convenios %}
                <div class="card mb-3 border-start border-primary border-4 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-primary fw-bold">{{ convenio.proveedor }} <span class="text-muted small">({{ convenio.rut_proveedor }})</span></h6>
                        <span class="badge bg-info text-dark">Saldo: ${{ "{:,.0f}".format((convenio.monto_adjudicado|float - convenio.total_ocs|float)) }}</span>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-md-3"><small class="text-muted d-block">Monto Adjudicado</small><strong>${{ "{:,.0f}".format(convenio.monto_adjudicado|float) }}</strong></div>
                            <div class="col-md-3"><small class="text-muted d-block">Total Usado</small><strong>${{ "{:,.0f}".format(convenio.total_ocs|float) }}</strong></div>
                            <div class="col-md-3"><small class="text-muted d-block">Fecha T茅rmino</small><strong>{{ convenio.fecha_termino or 'N/A' }}</strong></div>
                            <div class="col-md-3"><small class="text-muted d-block">Tiempo Restante</small><span class="text-primary fw-bold">{{ convenio.tiempo_restante }}</span></div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm" onclick="showAddOcModal({{ convenio.id }})"><i class="fas fa-plus"></i> Agregar OC</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="showEditConvenioModal(this)" data-json='{{ convenio|tojson|forceescape }}'><i class="fas fa-user-edit"></i> Modificar Proveedor</button>
                            
                            <div class="ms-auto">
                                <a class="btn btn-link btn-sm text-decoration-none" data-bs-toggle="collapse" href="#ocs-{{ convenio.id }}">Ver OCs</a>
                                <form action="{{ url_for('api_delete_convenio', convenio_id=convenio.id) }}" method="POST" class="d-inline" onsubmit="return confirm('驴Eliminar proveedor y sus OCs?');">
                                    <button type="submit" class="btn btn-link btn-sm text-danger"><i class="fas fa-trash-alt"></i></button>
                                </form>
                            </div>
                        </div>

                        <div class="collapse mt-3" id="ocs-{{ convenio.id }}">
                            <div class="table-responsive bg-white p-2 rounded border">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light"><tr><th>N掳 OC</th><th>Monto</th><th>Fecha</th><th>Acci贸n</th></tr></thead>
                                    <tbody>
                                        {% for oc in convenio.ocs %}
                                        <tr>
                                            <td>{{ oc.numero_oc }}</td>
                                            <td>${{ "{:,.0f}".format(oc.monto|float) }}</td>
                                            <td>{{ oc.fecha_emision or 'N/A' }}</td>
                                            <td>
                                                <button class="btn btn-link btn-sm p-0" onclick="showEditOcModal(this)" data-json='{{ oc|tojson|forceescape }}'><i class="fas fa-edit text-secondary"></i></button>
                                                <form action="{{ url_for('api_delete_oc', oc_id=oc.id) }}" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-link btn-sm p-0 text-danger" onclick="return confirm('驴Eliminar OC?')"><i class="fas fa-trash-alt"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr><td colspan="4" class="text-center text-muted">Sin 贸rdenes de compra</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-light border text-center">No hay proveedores registrados.</div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info shadow-sm text-center">No hay licitaciones registradas. 隆Comienza agregando una!</div>
    {% endfor %}
</div>

<div class="modal fade" id="modalAddLicitacion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title">Nueva Licitaci贸n</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form id="formAddLicitacion" action="{{ url_for('api_add_licitacion') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">ID Licitaci贸n</label><input type="text" name="id_licitacion" class="form-control" placeholder="Ej: 2332-1-LQ24" required></div>
                    <div class="mb-3"><label class="form-label">Nombre Licitaci贸n</label><input type="text" name="nombre_licitacion" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Requirente / Unidad</label><input type="text" name="requirente" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Inspector T茅cnico</label><input type="text" name="inspector_tecnico" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Decreto Adjudicaci贸n</label><input type="text" name="decreto_adjudicacion" class="form-control"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button><button type="submit" class="btn btn-primary">Guardar</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditLicitacion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white"><h5 class="modal-title">Modificar Licitaci贸n</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form id="formEditLicitacion" action="{{ url_for('api_update_licitacion') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="licitacion_id" id="edit-lic-id">
                    <div class="mb-3"><label class="form-label">ID Licitaci贸n</label><input type="text" name="id_licitacion" id="edit-lic-cod" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Nombre Licitaci贸n</label><input type="text" name="nombre_licitacion" id="edit-lic-nom" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Requirente</label><input type="text" name="requirente" id="edit-lic-req" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Inspector T茅cnico</label><input type="text" name="inspector_tecnico" id="edit-lic-insp" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">Decreto Adjudicaci贸n</label><input type="text" name="decreto_adjudicacion" id="edit-lic-dec" class="form-control"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Actualizar</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddConvenio" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white"><h5 class="modal-title">Vincular Proveedor Adjudicado</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form id="formAddConvenio" action="{{ url_for('api_add_convenio') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="licitacion_id" id="form_convenio_licitacion_id">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label fw-bold">Nombre Proveedor</label><input type="text" name="proveedor" class="form-control" required></div>
                        <div class="col-md-6 mb-3"><label class="form-label fw-bold">RUT Proveedor</label><input type="text" name="rut_proveedor" class="form-control" required></div>
                        <div class="col-md-6 mb-3"><label class="form-label fw-bold">Monto Adjudicado ($)</label><input type="number" name="monto_adjudicado" class="form-control" required></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Plazo (Meses)</label><input type="number" name="meses" class="form-control"></div>
                        <div class="col-md-6 mb-3"><label class="form-label text-success fw-bold">Fecha Inicio</label><input type="date" name="fecha_inicio" class="form-control"></div>
                        <div class="col-md-6 mb-3"><label class="form-label text-danger fw-bold">Fecha T茅rmino</label><input type="date" name="fecha_termino" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-success">Guardar Proveedor</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditConvenio" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Modificar Datos del Proveedor</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form id="formEditConvenio" action="{{ url_for('api_update_convenio') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="convenio_id" id="edit-conv-id">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Proveedor</label><input type="text" name="proveedor" id="edit-conv-prov" class="form-control"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">RUT</label><input type="text" name="rut_proveedor" id="edit-conv-rut" class="form-control"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Monto</label><input type="number" name="monto_adjudicado" id="edit-conv-monto" class="form-control"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Fecha T茅rmino</label><input type="date" name="fecha_termino" id="edit-conv-fin" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary">Actualizar Datos</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddOc" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title">Nueva Orden de Compra</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form id="formAddOc" action="{{ url_for('api_add_oc') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="convenio_id" id="form_oc_convenio_id">
                    <div class="mb-3"><label class="form-label">N煤mero OC</label><input type="text" name="numero_oc" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Monto OC ($)</label><input type="number" step="0.01" name="monto" class="form-control" required></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary w-100">Guardar OC</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditOc" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Editar Orden de Compra</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form id="formEditOc" action="{{ url_for('api_update_oc') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="oc_id" id="edit-oc-id">
                    <div class="mb-3"><label>N煤mero OC</label><input type="text" name="numero_oc" id="edit-oc-num" class="form-control" required></div>
                    <div class="mb-3"><label>Monto</label><input type="number" step="0.01" name="monto" id="edit-oc-monto" class="form-control" required></div>
                    <div class="mb-3"><label>Fecha Emisi贸n</label><input type="date" name="fecha_emision" id="edit-oc-fecha" class="form-control"></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary">Guardar Cambios</button></div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    /** * FUNCIONES GLOBALES (Definidas fuera de cualquier bloque para evitar ReferenceError)
     */
    
    // Abrir Modal Agregar Proveedor
    function showAddConvenioModal(licitacionId) {
        document.getElementById('form_convenio_licitacion_id').value = licitacionId;
        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalAddConvenio'));
        modal.show();
    }

    // Abrir Modal Agregar OC
    function showAddOcModal(convenioId) {
        document.getElementById('form_oc_convenio_id').value = convenioId;
        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalAddOc'));
        modal.show();
    }

    // Abrir Modal Editar Licitaci贸n
    function showEditLicitacionModal(btn) {
        try {
            const data = JSON.parse(btn.getAttribute('data-json'));
            document.getElementById('edit-lic-id').value = data.id;
            document.getElementById('edit-lic-cod').value = data.id_licitacion || '';
            document.getElementById('edit-lic-nom').value = data.nombre_licitacion || '';
            document.getElementById('edit-lic-req').value = data.requirente || '';
            document.getElementById('edit-lic-insp').value = data.inspector_tecnico || '';
            document.getElementById('edit-lic-dec').value = data.decreto_adjudicacion || '';
            
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalEditLicitacion'));
            modal.show();
        } catch (e) { console.error("Error al parsear JSON Licitaci贸n", e); }
    }

    // Abrir Modal Editar Proveedor
    function showEditConvenioModal(btn) {
        try {
            const data = JSON.parse(btn.getAttribute('data-json'));
            document.getElementById('edit-conv-id').value = data.id;
            document.getElementById('edit-conv-prov').value = data.proveedor || '';
            document.getElementById('edit-conv-rut').value = data.rut_proveedor || '';
            document.getElementById('edit-conv-monto').value = data.monto_adjudicado || '';
            document.getElementById('edit-conv-fin').value = data.fecha_termino || '';
            
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalEditConvenio'));
            modal.show();
        } catch (e) { console.error("Error al parsear JSON Proveedor", e); }
    }

    // Abrir Modal Editar OC
    function showEditOcModal(btn) {
        try {
            const data = JSON.parse(btn.getAttribute('data-json'));
            document.getElementById('edit-oc-id').value = data.id;
            document.getElementById('edit-oc-num').value = data.numero_oc || '';
            document.getElementById('edit-oc-monto').value = data.monto || '';
            // Limpiar fecha (YYYY-MM-DD HH:MM:SS -> YYYY-MM-DD)
            let fechaRaw = data.fecha_emision ? data.fecha_emision.split(' ')[0] : '';
            document.getElementById('edit-oc-fecha').value = fechaRaw;
            
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalEditOc'));
            modal.show();
        } catch (e) { console.error("Error al parsear JSON OC", e); }
    }

    // MANEJO DE ENVO DE FORMULARIOS (AJAX)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('form[id^="form"]').forEach(form => {
            // No interceptar formularios de eliminaci贸n que usan confirm()
            if (form.getAttribute('onsubmit') && form.getAttribute('onsubmit').includes('confirm')) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);

                fetch(this.action, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Recargar p谩gina tras 茅xito
                        window.location.reload();
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                })
                .catch(err => {
                    console.error("Error env铆o:", err);
                    Swal.fire('Error', 'Problema de conexi贸n con el servidor', 'error');
                });
            });
        });
    });
</script>
{% endblock %}
